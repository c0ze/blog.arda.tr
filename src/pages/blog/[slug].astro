---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sortedPosts = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  return sortedPosts.map((post, index) => {
    // Extract the filename without extensions and without the year parent directory for the slug
    const slug = post.id.split('/').pop() || post.id;
    
    return {
      params: { slug },
      props: {
        post,
        prevPost: sortedPosts[index + 1] || null,
        nextPost: sortedPosts[index - 1] || null,
      },
    };
  });
}

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await render(post);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Determine OG image - use post image if available, otherwise default
const ogImage = post.data.image || '/images/og-image.png';
---

<BaseLayout
  title={`${post.data.title} - Coze`}
  description={post.data.description || post.data.excerpt}
  image={ogImage}
  keywords={post.data.keywords}
>
  <article class="container mx-auto px-4 py-16 max-w-4xl">
    <!-- Header -->
    <header class="mb-12 animate-fade-in">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors mb-6"
      >
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m12 19-7-7 7-7"/>
          <path d="M19 12H5"/>
        </svg>
        Back to Blog
      </a>

      <div class="flex flex-wrap items-center gap-4 text-sm text-muted-foreground mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 2v4"/>
            <path d="M16 2v4"/>
            <rect width="18" height="18" x="3" y="4" rx="2"/>
            <path d="M3 10h18"/>
          </svg>
          <time datetime={post.data.date.toISOString()}>{formattedDate}</time>
        </div>
        {post.data.author && (
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="8" r="5"/>
              <path d="M20 21a8 8 0 0 0-16 0"/>
            </svg>
            <span>{post.data.author}</span>
          </div>
        )}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-foreground to-primary bg-clip-text text-transparent">
        {post.data.title}
      </h1>

      <div class="flex flex-wrap gap-2 mb-8">
        {post.data.tags.map((tag) => (
          <span class="inline-flex items-center rounded-md bg-secondary px-2.5 py-0.5 text-sm font-mono font-medium text-secondary-foreground hover:bg-primary hover:text-primary-foreground transition-colors">
            #{tag}
          </span>
        ))}
      </div>
    </header>

    <!-- Excerpt -->
    {post.data.excerpt && (
      <div class="bg-card border border-border rounded-lg p-8 mb-8 animate-slide-up">
        <p class="text-lg leading-relaxed text-muted-foreground">
          {post.data.excerpt}
        </p>
      </div>
    )}

    <!-- Content -->
    <div class="prose prose-lg max-w-none dark:prose-invert prose-headings:text-foreground prose-p:text-foreground prose-strong:text-foreground prose-a:text-primary hover:prose-a:text-primary/80 prose-code:text-primary prose-pre:bg-card prose-pre:border prose-pre:border-border animate-slide-up">
      <Content />
    </div>

    <!-- Navigation -->
    <nav class="mt-16 pt-8 border-t border-border">
      <div class="grid md:grid-cols-2 gap-4">
        {prevPost && (
          <a
            href={`/blog/${prevPost.id.split('/').pop()}`}
            class="group flex flex-col p-4 rounded-lg border border-border hover:border-primary/50 hover:bg-card transition-all"
          >
            <span class="text-sm text-muted-foreground mb-1 flex items-center gap-1">
              <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m15 18-6-6 6-6"/>
              </svg>
              Previous
            </span>
            <span class="font-medium group-hover:text-primary transition-colors line-clamp-1">
              {prevPost.data.title}
            </span>
          </a>
        )}
        {!prevPost && <div />}
        {nextPost && (
          <a
            href={`/blog/${nextPost.id.split('/').pop()}`}
            class="group flex flex-col p-4 rounded-lg border border-border hover:border-primary/50 hover:bg-card transition-all text-right md:col-start-2"
          >
            <span class="text-sm text-muted-foreground mb-1 flex items-center justify-end gap-1">
              Next
              <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m9 18 6-6-6-6"/>
              </svg>
            </span>
            <span class="font-medium group-hover:text-primary transition-colors line-clamp-1">
              {nextPost.data.title}
            </span>
          </a>
        )}
      </div>
    </nav>
  </article>

  <!-- JSON-LD Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description || post.data.excerpt,
    "datePublished": post.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": post.data.author || "Coze",
      "url": "https://blog.arda.tr"
    },
    "publisher": {
      "@type": "Person",
      "name": "Coze"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://blog.arda.tr/blog/${post.id.split('/').pop()}`
    },
    "keywords": post.data.keywords
  })} />
</BaseLayout>
